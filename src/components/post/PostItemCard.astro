---
// 导入所需的库和类型
import { Badge } from '@components/ui/badge';
import { Button } from '@components/ui/button';
import { Routes } from '@constants/router';
import { buildCategoryPath, getCategoryArr, getPostCover, getPostDescriptionWithSummary } from '@lib/content';
import { getLqipProps } from '@lib/lqip';
import { routeBuilder } from '@lib/route';
import { cn } from '@lib/utils';
import { Icon } from 'astro-icon/components';
import { formatInTimeZone } from 'date-fns-tz';
import readingTime from 'reading-time';
import type { BlogPost } from 'types/blog';

export interface PostItemCardProps {
  data: BlogPost;
  leftClip?: boolean;
  showTags?: boolean;
  hideCover?: boolean; // 隐藏图片，让内容铺满
  isSimple?: boolean; // 是否简单模式
}

const {
  data,
  leftClip = true,
  hideCover: hideCoverProp,
  showTags: showTagsProp,
  isSimple = false,
} = Astro.props as PostItemCardProps;

const showTags = showTagsProp ?? !isSimple;
const hideCover = hideCoverProp ?? isSimple;

const { date, catalog, categories, title, draft } = data?.data ?? {};
const { body } = data ?? {};

const readState = readingTime(body ?? '');
const finalCover = getPostCover(data);
const href = routeBuilder(Routes.Post, data as BlogPost);
const isDraft = import.meta.env.DEV && draft === true;

const categoryArr = getCategoryArr(categories?.[0]);
const categoryLink = await buildCategoryPath(categoryArr);
const categoryStr = categoryArr?.length ? categoryArr[categoryArr.length - 1] : '';

// 使用统一的工具函数获取文章描述（带 AI 摘要 fallback）
const postDescription = getPostDescriptionWithSummary(data);

// 获取 LQIP 样式用于图片占位符
const lqipProps = getLqipProps(finalCover);
---

<div
  class={cn(
    'hover:shadow-card-darker group text-card-foreground shadow-card relative flex gap-2 rounded-lg bg-white transition-shadow md:flex-col dark:bg-transparent',
    'post-item-card',
  )}
>
  {
    !hideCover && (
      <a
        aria-label="post-link"
        href={href}
        style={lqipProps.style}
        class={cn(
          'md:clip-path-none relative z-1 h-46.5 max-h-46.5 w-[calc(50%-2rem)] overflow-hidden rounded-lg md:w-auto',
          leftClip ? 'clip-path-post-img-left order-1' : 'clip-path-post-img-right order-2',
          'md:clip-path-none md:order-0',
          lqipProps.class,
        )}
      >
        <img
          src={finalCover}
          loading="lazy"
          alt="post cover"
          class="h-full w-full cursor-pointer object-cover transition duration-500 group-hover:scale-110 group-hover:rotate-3"
        />
      </a>
    )
  }
  <div
    class={cn(
      'flex flex-col gap-2 px-4 pb-2 md:pb-4 pt-4 md:pt-1',
      hideCover ? 'w-full' : 'w-[calc(50%+2rem)] md:w-full',
      !hideCover && (leftClip ? 'order-2' : 'order-1'),
      'md:order-0',
    )}
  >
    <div class={cn('flex w-full justify-between', { 'order-2 justify-start gap-4 pb-3 md:pb-0': isSimple })}>
      {
        catalog === false ? null : (
          <a
            href={categoryLink}
            class="flex-center hover:text-blue text-muted-foreground relative z-1 text-xs transition duration-300"
          >
            <Icon name="gg:flag" />
            {categoryStr}
          </a>
        )
      }
      <div class="text-muted-foreground flex justify-end gap-4 text-xs">
        {
          date ? (
            <p class="flex-center gap-1">
              <Icon name="fa6-solid:calendar-days" />
              {formatInTimeZone(date, 'UTC', 'yyyy-MM-dd')}
            </p>
          ) : null
        }
        <p class="flex-center gap-1">
          <Icon name="fa6-solid:pen-nib" />
          {readState?.words} 字
        </p>
        <button
          class="flex-center gap-1 md:hidden"
          title={`预计阅读时长: ${readState?.minutes} min`}
          data-tooltip-placement="top"
        >
          <Icon name="fa6-solid:clock" />
          {readState?.text}
        </button>
      </div>
    </div>
    <div class="mt-1 flex flex-col space-y-1.5 p-0">
      <div class="flex items-center gap-2">
        <a href={href} aria-label="post-link" class="after:absolute after:inset-0 min-w-0 flex-1"
          ><h1 class="text-primary hover:text-blue line-clamp-1 truncate text-xl font-bold transition-colors duration-300">
            {title}
          </h1>
        </a>
        {
          isDraft && (
            <Badge className="bg-yellow-700 border border-yellow-600/20 gap-1 text-white shrink-0 hover:bg-yellow-500 whitespace-nowrap transition-colors duration-300 relative z-1">
              <Icon name="fa6-solid:file-pen" class="h-3 w-3" />
              草稿
            </Badge>
          )
        }
      </div>
    </div>
    <p
      class={cn('text-muted-foreground line-clamp-4 h-13 text-sm md:h-auto md:max-h-13', {
        'line-clamp-2 h-10 md:max-h-10': isSimple,
      })}
    >
      {postDescription}
    </p>
    {
      showTags && (
        <div
          class={cn(
            '@container mt-0 flex gap-2 relative z-1',
            hideCover ? 'justify-start' : leftClip ? 'justify-start' : 'justify-end',
            'md:justify-start',
          )}
        >
          {data?.data.tags?.length
            ? data?.data.tags.map((tag: string, index: number) => (
                <a href={`/tags/${tag.toLowerCase().replace(/\//g, '-')}`} class="relative z-1">
                  <Badge
                    className={cn(
                      'hover:text-badge-primary/80 hidden cursor-pointer gap-0.5 border-none px-1 text-xs font-bold whitespace-nowrap transition-colors duration-300 @md:flex',
                      {
                        '@xs:flex': index < 2,
                        '@sm:flex': index < 3,
                      },
                    )}
                    variant="outline"
                  >
                    <Icon name="fa6-solid:tags" /> {tag}
                  </Badge>
                </a>
              ))
            : null}
        </div>
      )
    }
    <a
      href={href}
      aria-label="more info"
      class={cn(
        'more-link absolute bottom-0 h-12 w-12 overflow-hidden rounded-br-lg z-1',
        hideCover ? 'right-0' : leftClip ? 'right-0' : 'left-0 rounded-br-none rounded-bl-lg',
        'md:left-auto md:right-0 md:rounded-br-lg md:rounded-bl-none',
      )}
    >
      <div class="more-peel"></div>
      <Icon
        name="ri:arrow-right-line"
        class={cn(
          'more-arrow absolute z-1 h-6 w-6 text-white opacity-0 transition-all duration-500 ease-out',
          hideCover ? 'right-1 bottom-[-20px]' : leftClip ? 'right-1 bottom-[-20px]' : 'left-1 bottom-[-20px] rotate-180',
          'md:right-1 md:left-auto md:rotate-0',
        )}
      />
    </a>
  </div>
</div>

<style>
  .more-link .more-peel {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 100%;
    height: 100%;
    background: var(--gradient-shoka-button);
    transition: all 0.4s ease-out;
    clip-path: polygon(100% 100%, 100% 100%, 100% 100%);
  }

  .more-link:hover .more-peel {
    clip-path: polygon(0 100%, 100% 0, 100% 100%);
  }

  .more-link:hover .more-arrow {
    opacity: 1;
    bottom: 4px;
  }

  /* 处理左侧翻页效果 */
  .more-link.left-0 .more-peel {
    right: auto;
    left: 0;
    clip-path: polygon(0 100%, 0 100%, 0 100%);
  }

  .more-link.left-0:hover .more-peel {
    clip-path: polygon(0 0, 0 100%, 100% 100%);
  }

  .more-link.left-0:hover .more-arrow {
    opacity: 1;
    bottom: 4px;
  }

  /* 圣诞特效开启时的卡片样式 */
  :global(html.christmas) .post-item-card {
    position: relative;
    z-index: 5;
  }

  :global(html.christmas.dark) .post-item-card {
    background-color: #1a1512;
  }
</style>
